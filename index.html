<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>The Lakes ‚Äî Tee Time Booker</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root { --green:#1a2e1a; --green-mid:#2d4a2d; --green-light:#3d6b3d; --gold:#c9a84c; --gold-light:#e2c97e; --cream:#f5f0e8; --cream-dark:#ede5d0; --text:#1a1a18; --text-muted:#5a5a50; --white:#fdfcf8; }
  html,body { background:var(--cream); color:var(--text); font-family:'DM Mono',monospace; min-height:100vh; }
  body { background-image:radial-gradient(ellipse at 20% 50%,rgba(29,70,29,.06) 0%,transparent 60%); }
  header { background:var(--green); padding:0 48px; display:flex; align-items:center; justify-content:space-between; height:72px; position:sticky; top:0; z-index:100; box-shadow:0 2px 24px rgba(0,0,0,.3); }
  .logo { display:flex; align-items:center; gap:16px; }
  .logo-emblem { width:36px; height:36px; border:1.5px solid var(--gold); border-radius:50%; display:flex; align-items:center; justify-content:center; font-family:'Cormorant Garamond',serif; color:var(--gold); font-size:16px; }
  .logo-text { font-family:'Cormorant Garamond',serif; color:var(--cream); font-size:18px; font-weight:300; letter-spacing:3px; text-transform:uppercase; }
  .logo-text span { color:var(--gold); }
  .header-right { font-size:10px; color:rgba(245,240,232,.4); letter-spacing:2px; text-transform:uppercase; }
  main { max-width:960px; margin:0 auto; padding:56px 32px 80px; }
  .page-title { font-family:'Cormorant Garamond',serif; font-size:48px; font-weight:300; font-style:italic; color:var(--green); margin-bottom:6px; line-height:1.1; }
  .page-subtitle { font-size:11px; letter-spacing:3px; text-transform:uppercase; color:var(--text-muted); margin-bottom:48px; }
  .section { background:var(--white); border:1px solid var(--cream-dark); border-radius:2px; margin-bottom:24px; overflow:hidden; animation:fadeUp .5s ease both; }
  .section:nth-child(2){animation-delay:.05s} .section:nth-child(3){animation-delay:.10s} .section:nth-child(4){animation-delay:.15s} .section:nth-child(5){animation-delay:.20s} .section:nth-child(6){animation-delay:.25s}
  @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  .section-header { background:var(--green); padding:14px 28px; display:flex; align-items:center; gap:12px; }
  .section-num { font-size:10px; color:var(--gold); letter-spacing:2px; }
  .section-title { font-family:'Cormorant Garamond',serif; font-size:16px; color:var(--cream); letter-spacing:1px; text-transform:uppercase; }
  .section-body { padding:28px; }
  label { display:block; font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--text-muted); margin-bottom:8px; }
  input[type=text],input[type=password],input[type=date],select { width:100%; background:var(--cream); border:1px solid var(--cream-dark); border-radius:1px; padding:12px 16px; font-family:'DM Mono',monospace; font-size:13px; color:var(--text); outline:none; transition:border-color .2s,box-shadow .2s; appearance:none; }
  input:focus,select:focus { border-color:var(--green-light); box-shadow:0 0 0 3px rgba(61,107,61,.1); }
  .field-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
  .field { margin-bottom:16px; } .field:last-child { margin-bottom:0; }

  .book-chip { position:relative; }
  .book-chip input { position:absolute; opacity:0; }

  /* BOOK TYPE */
  .book-options { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .book-chip label { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding:24px 16px; border:1px solid var(--cream-dark); background:var(--cream); cursor:pointer; transition:all .2s; border-radius:1px; margin:0; text-align:center; }
  .book-icon { font-size:32px; }
  .book-name { font-family:'Cormorant Garamond',serif; font-size:18px; color:var(--text); }
  .book-desc { font-size:10px; letter-spacing:1px; color:var(--text-muted); }
  .book-chip input:checked+label { background:var(--green); border-color:var(--green); }
  .book-chip input:checked+label .book-name, .book-chip input:checked+label .book-desc { color:var(--gold-light); }
  .book-chip label:hover { border-color:var(--green-light); }

  /* DATE */
  .date-hint { font-size:11px; color:var(--text-muted); margin-top:8px; }
  .date-hint span { color:var(--green-light); }

  /* TIME */
  .time-range { display:grid; grid-template-columns:1fr auto 1fr; gap:16px; align-items:center; }
  .time-sep { font-family:'Cormorant Garamond',serif; font-size:20px; color:var(--text-muted); text-align:center; font-style:italic; }
  select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235a5a50' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:36px; }

  /* GENERATE */
  .generate-wrap { margin-top:32px; text-align:center; }
  .btn-generate { background:var(--green); color:var(--cream); border:none; padding:18px 56px; font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:300; letter-spacing:4px; text-transform:uppercase; cursor:pointer; border-radius:1px; transition:all .25s; }
  .btn-generate:hover { background:var(--green-mid); letter-spacing:6px; box-shadow:0 8px 32px rgba(26,46,26,.3); }
  .btn-generate-sub { display:block; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:2px; color:rgba(245,240,232,.5); margin-top:4px; }

  /* OUTPUT */
  .output-section { display:none; margin-top:32px; }
  .output-section.visible { display:block; animation:fadeUp .4s ease both; }
  .divider { height:1px; background:linear-gradient(90deg,transparent,var(--gold),transparent); margin:40px 0; opacity:.4; }
  .output-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:12px; }
  .output-title { font-family:'Cormorant Garamond',serif; font-size:24px; font-weight:300; color:var(--green); }
  .output-actions { display:flex; gap:10px; }
  .btn-action { background:none; border:1px solid var(--green-light); padding:10px 20px; font-family:'DM Mono',monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--green-light); cursor:pointer; border-radius:1px; transition:all .2s; text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
  .btn-action:hover { background:var(--green); color:var(--cream); border-color:var(--green); }
  .btn-action.primary { background:var(--green); color:var(--cream); border-color:var(--green); }
  .btn-action.primary:hover { background:var(--green-mid); }
  .btn-action.copied { background:var(--green); color:var(--gold); border-color:var(--green); }
  pre { background:var(--green); color:#a8d5a8; padding:28px; font-family:'DM Mono',monospace; font-size:12px; line-height:1.8; border-radius:2px; overflow-x:auto; white-space:pre-wrap; word-break:break-all; max-height:400px; overflow-y:auto; }
  .instructions { margin-top:20px; background:var(--cream); border:1px solid var(--cream-dark); border-left:3px solid var(--gold); padding:20px 24px; border-radius:1px; }
  .instructions p { font-size:12px; line-height:1.8; color:var(--text-muted); margin-bottom:8px; }
  .instructions p:last-child { margin-bottom:0; }
  .step { display:flex; align-items:center; gap:14px; padding:14px 20px; border-radius:2px; font-size:12px; letter-spacing:1px; border:1px solid var(--cream-dark); background:var(--white); transition:all .3s; }
  .step.pending { color:var(--text-muted); }
  .step.running { border-color:var(--gold); background:rgba(201,168,76,.06); color:var(--text); }
  .step.success { border-color:var(--green-light); background:rgba(61,107,61,.06); color:var(--green); }
  .step.error   { border-color:#c0392b; background:rgba(192,57,43,.06); color:#c0392b; }
  .step-icon { font-size:18px; width:24px; text-align:center; flex-shrink:0; }
  .step-text { flex:1; }
  .step-detail { font-size:10px; color:var(--text-muted); margin-top:2px; letter-spacing:.5px; }
  .spinner { width:18px; height:18px; border:2px solid var(--gold); border-top-color:transparent; border-radius:50%; animation:spin .7s linear infinite; flex-shrink:0; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .gh-success-banner { background:var(--green); color:var(--cream); padding:24px 28px; border-radius:2px; margin-top:16px; }
  .gh-success-banner h3 { font-family:'Cormorant Garamond',serif; font-size:22px; color:var(--gold-light); margin-bottom:8px; }
  .gh-success-banner p { font-size:12px; line-height:1.8; color:rgba(245,240,232,.8); }
  .gh-success-banner code { background:rgba(0,0,0,.3); padding:2px 6px; border-radius:2px; font-family:'DM Mono',monospace; font-size:11px; color:var(--gold-light); }
  .gh-link { color:var(--gold-light); text-decoration:none; border-bottom:1px solid rgba(201,168,76,.4); }
  .gh-link:hover { border-bottom-color:var(--gold); }

  /* SCHEDULE */
  .sched-row { display:flex; align-items:center; justify-content:space-between; padding:18px 28px; border-bottom:1px solid var(--cream-dark); transition:background .2s; gap:16px; }
  .sched-row:last-child { border-bottom:none; }
  .sched-row:hover { background:var(--cream); }
  .sched-left { flex:1; min-width:0; }
  .sched-play-date { font-family:'Cormorant Garamond',serif; font-size:20px; color:var(--green); font-weight:400; margin-bottom:6px; }
  .sched-meta { display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
  .sched-detail { font-size:10px; color:var(--text-muted); letter-spacing:.5px; }
  .badge { font-size:9px; letter-spacing:1.5px; text-transform:uppercase; padding:3px 8px; border-radius:20px; font-weight:400; }
  .badge-future { background:rgba(61,107,61,.12); color:var(--green-light); border:1px solid rgba(61,107,61,.2); }
  .badge-today  { background:rgba(201,168,76,.15); color:#8a6a10; border:1px solid rgba(201,168,76,.3); animation:pulse 2s ease-in-out infinite; }
  .badge-past   { background:var(--cream-dark); color:var(--text-muted); border:1px solid var(--cream-dark); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
  .sched-right { display:flex; align-items:center; gap:16px; flex-shrink:0; }
  .sched-countdown { font-family:'Cormorant Garamond',serif; font-size:16px; color:var(--green); font-style:italic; white-space:nowrap; }
  .sched-countdown.past { color:var(--text-muted); }
  .sched-delete { background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:12px; padding:4px 6px; border-radius:2px; transition:all .2s; line-height:1; }
  .sched-delete:hover { background:rgba(192,57,43,.1); color:#c0392b; }
  /* TIME PICKER */
  .time-picker-wrap { display:flex; align-items:stretch; gap:0; background:var(--cream); border:1px solid var(--cream-dark); border-radius:1px; overflow:hidden; width:fit-content; height:47px; }
  .time-picker-wrap select { background:transparent; border:none; border-radius:0; padding:0 14px; font-family:'Cormorant Garamond',serif; font-size:20px; color:var(--green); font-weight:400; width:64px; text-align:center; cursor:pointer; box-shadow:none; background-image:none; height:100%; }
  .time-picker-wrap select:focus { outline:none; background:rgba(61,107,61,.06); }
  .time-picker-wrap select:first-child { border-right:1px solid var(--cream-dark); }
  .time-picker-colon { font-family:'Cormorant Garamond',serif; font-size:24px; color:var(--gold); padding:0 4px; display:flex; align-items:center; user-select:none; }
  .sched-run-info { display:flex; align-items:center; gap:10px; margin-top:8px; padding:8px 12px; background:var(--cream); border-radius:1px; border:1px solid var(--cream-dark); flex-wrap:wrap; }
  .sched-run-info.today { background:rgba(201,168,76,.08); border-color:rgba(201,168,76,.3); }
  .sched-run-info.past  { opacity:.6; }
  .sched-run-label { font-size:10px; letter-spacing:1px; text-transform:uppercase; color:var(--text-muted); }
  .sched-run-datetime { font-family:'Cormorant Garamond',serif; font-size:15px; color:var(--green); font-weight:600; }
  .sched-run-countdown { font-size:10px; background:rgba(61,107,61,.12); color:var(--green-light); padding:2px 8px; border-radius:10px; letter-spacing:.5px; }
  .sched-actions-link { font-size:10px; color:var(--gold); letter-spacing:1px; text-decoration:none; margin-left:auto; border-bottom:1px solid rgba(201,168,76,.3); }
  .sched-actions-link:hover { border-bottom-color:var(--gold); }

  /* SECRETS BANNER */
  .secrets-banner { display:flex; flex-direction:column; gap:16px; }
  .secrets-icon { font-size:32px; }
  .secrets-text { font-size:12px; line-height:1.8; color:var(--text-muted); }
  .secrets-text strong { color:var(--text); font-size:13px; }
  .secrets-text p { margin-top:4px; }
  .secrets-fields { display:flex; flex-direction:column; gap:8px; margin-top:4px; }
  .secrets-field { display:flex; align-items:center; gap:12px; background:var(--cream); border:1px solid var(--cream-dark); padding:10px 16px; border-radius:1px; }
  .secrets-key { font-family:'DM Mono',monospace; font-size:11px; color:var(--green); background:rgba(61,107,61,.1); padding:2px 8px; border-radius:2px; white-space:nowrap; }
  .secrets-val { font-size:11px; color:var(--text-muted); letter-spacing:.3px; }
</style>
</head>
<body>
<header>
  <div class="logo"><div class="logo-emblem">L</div><div class="logo-text">The <span>Lakes</span></div></div>
  <div class="header-right">Tee Time Automation</div>
</header>
<main>
  <h1 class="page-title">Configure your<br/>booking agent</h1>
  <p class="page-subtitle">Fill in the details below to generate your personalised booking script</p>

  <!-- BOOKING TYPE -->
  <div class="section">
    <div class="section-header"><span class="section-num">02</span><span class="section-title">Booking Preferences</span></div>
    <div class="section-body">
      <label style="margin-bottom:14px;">Booking Type</label>
      <div class="book-options" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:24px;">
        <div class="book-chip">
          <input type="radio" name="booktype" id="bt-group" value="group" checked />
          <label for="bt-group">
            <span class="book-icon">üë•</span>
            <span class="book-name">Book Group</span>
            <span class="book-desc">Book the whole tee time for your group</span>
          </label>
        </div>
        <div class="book-chip">
          <input type="radio" name="booktype" id="bt-join" value="join" />
          <label for="bt-join">
            <span class="book-icon">ü§ù</span>
            <span class="book-name">Join a Group</span>
            <span class="book-desc">Add yourself to a slot where others are already booked</span>
          </label>
        </div>
        <div class="book-chip">
          <input type="radio" name="booktype" id="bt-new" value="new" />
          <label for="bt-new">
            <span class="book-icon">üèåÔ∏è</span>
            <span class="book-name">New Slot</span>
            <span class="book-desc">Start fresh in an empty tee time slot</span>
          </label>
        </div>
      </div>
      <label style="margin-bottom:14px;">Starting Tee</label>
      <div class="book-options" style="grid-template-columns:1fr 1fr 1fr;">
        <div class="book-chip">
          <input type="radio" name="tee" id="tee-1st" value="1ST TEE" checked />
          <label for="tee-1st">
            <span class="book-icon">üèÅ</span>
            <span class="book-name">1st Tee</span>
            <span class="book-desc">Start from the 1st tee</span>
          </label>
        </div>
        <div class="book-chip">
          <input type="radio" name="tee" id="tee-10th" value="10TH TEE" />
          <label for="tee-10th">
            <span class="book-icon">üîü</span>
            <span class="book-name">10th Tee</span>
            <span class="book-desc">Start from the 10th tee</span>
          </label>
        </div>
        <div class="book-chip">
          <input type="radio" name="tee" id="tee-any" value="ANY" />
          <label for="tee-any">
            <span class="book-icon">üéØ</span>
            <span class="book-name">Either</span>
            <span class="book-desc">Don't mind ‚Äî first available slot</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- DATE -->
  <div class="section">
    <div class="section-header"><span class="section-num">03</span><span class="section-title">Date to Book</span></div>
    <div class="section-body">
      <div class="field">
        <label>Which Saturday do you want to book?</label>
        <input type="date" id="bookingDate" />
        <p class="date-hint" id="dateHint">Select a date above</p>
      </div>
    </div>
  </div>

  <!-- TIME -->
  <div class="section">
    <div class="section-header"><span class="section-num">04</span><span class="section-title">Tee Time Preferences</span></div>
    <div class="section-body">
      <label style="margin-bottom:14px;">Preferred Time Window</label>
      <div class="time-range">
        <div class="field" style="margin:0"><label>Earliest</label>
          <select id="earliest">
            <option value="06:00">6:00 am</option><option value="06:30">6:30 am</option><option value="07:00">7:00 am</option><option value="07:30">7:30 am</option>
            <option value="08:00" selected>8:00 am</option><option value="08:30">8:30 am</option><option value="09:00">9:00 am</option><option value="09:30">9:30 am</option>
            <option value="10:00">10:00 am</option><option value="10:30">10:30 am</option><option value="11:00">11:00 am</option><option value="11:30">11:30 am</option>
            <option value="12:00">12:00 pm</option><option value="12:30">12:30 pm</option><option value="13:00">1:00 pm</option><option value="13:30">1:30 pm</option>
            <option value="14:00">2:00 pm</option><option value="14:30">2:30 pm</option><option value="15:00">3:00 pm</option>
          </select>
        </div>
        <div class="time-sep">to</div>
        <div class="field" style="margin:0"><label>Latest</label>
          <select id="latest">
            <option value="07:00">7:00 am</option><option value="08:00">8:00 am</option><option value="09:00">9:00 am</option><option value="09:30">9:30 am</option>
            <option value="10:00" selected>10:00 am</option><option value="10:30">10:30 am</option><option value="11:00">11:00 am</option><option value="11:30">11:30 am</option>
            <option value="12:00">12:00 pm</option><option value="12:30">12:30 pm</option><option value="13:00">1:00 pm</option><option value="13:30">1:30 pm</option>
            <option value="14:00">2:00 pm</option><option value="14:30">2:30 pm</option><option value="15:00">3:00 pm</option><option value="15:30">3:30 pm</option>
            <option value="16:00">4:00 pm</option><option value="16:30">4:30 pm</option><option value="17:00">5:00 pm</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- GITHUB -->
  <div class="section">
    <div class="section-header"><span class="section-num">05</span><span class="section-title">GitHub Automation</span></div>
    <div class="section-body">
      <div class="field">
        <label>PIN to unlock GitHub access</label>
        <input type="password" id="ghPin" placeholder="Enter your PIN" maxlength="10" style="letter-spacing:4px;" />
        <p class="date-hint" id="pinHint">Enter your PIN to decrypt your stored GitHub token</p>
      </div>
      <!-- hidden field keeps API compatibility -->
      <input type="hidden" id="ghToken" />
      <div class="field-row">
        <div class="field" style="margin:0">
          <label>How many days before does booking open?</label>
          <select id="daysAdvance">
            <option value="0">‚ö° Now (test run)</option>
            <option value="7">7 days before</option>
            <option value="8">8 days before</option>
            <option value="9">9 days before</option>
            <option value="10" selected>10 days before</option>
            <option value="14">14 days before</option>
            <option value="21">21 days before</option>
            <option value="28">28 days before</option>
          </select>
        </div>
        <div class="field" style="margin:0">
          <label>What time do bookings open? (local time)</label>
          <div class="time-picker-wrap">
            <select id="openHour">
              <option value="05">05</option><option value="06">06</option><option value="07" selected>07</option>
              <option value="08">08</option><option value="09">09</option><option value="10">10</option>
              <option value="11">11</option><option value="12">12</option><option value="13">13</option>
              <option value="14">14</option><option value="15">15</option><option value="16">16</option>
            </select>
            <span class="time-picker-colon">:</span>
            <select id="openMinute">
              <option value="00" selected>00</option><option value="05">05</option><option value="10">10</option>
              <option value="15">15</option><option value="20">20</option><option value="25">25</option>
              <option value="30">30</option><option value="35">35</option><option value="40">40</option>
              <option value="45">45</option><option value="50">50</option><option value="55">55</option>
            </select>
          </div>
          <input type="hidden" id="openTime" value="07:00" />
        </div>
      </div>
      <p class="date-hint" id="scheduleHint" style="margin-top:8px;">Script will run 1 minute before bookings open</p>
    </div>
  </div>

  <div class="generate-wrap">
    <button class="btn-generate" onclick="generateAndPush()">Push to GitHub &amp; Schedule<span class="btn-generate-sub">updates script + sets Actions cron automatically</span></button>
    <div style="margin-top:12px;">
      <button class="btn-action" onclick="generate()" style="display:inline-flex;">‚Üì Just download the .py file</button>
    </div>
  </div>

  <!-- STATUS -->
  <div class="output-section" id="statusSection" style="margin-top:24px;">
    <div class="divider"></div>
    <div id="statusSteps" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;"></div>
  </div>

  <div class="output-section" id="outputSection">
    <div class="divider"></div>
    <div class="output-header">
      <h2 class="output-title">Your personalised script</h2>
      <div class="output-actions">
        <button class="btn-action" id="copyBtn" onclick="copyScript()">‚éò Copy</button>
        <button class="btn-action primary" onclick="downloadScript()">‚Üì Download .py</button>
      </div>
    </div>
    <pre id="scriptOutput"></pre>
    <div class="instructions" id="instructions"></div>
  </div>
  <!-- BOOKING SCHEDULE -->
  <div class="section" id="scheduleSection" style="margin-top:48px;">
    <div class="section-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:12px;">
        <span class="section-num">06</span>
        <span class="section-title">Booking Schedule</span>
      </div>
      <span style="font-size:10px;color:rgba(245,240,232,.4);letter-spacing:1px;">Saved on this device</span>
    </div>
    <div class="section-body" style="padding:0;">
      <div id="scheduleList"></div>
    </div>
  </div>
</main>

<script>
// Default to next Saturday
function getNextSat() {
  const d = new Date();
  const diff = (6 - d.getDay() + 7) % 7 || 7;
  d.setDate(d.getDate() + diff);
  return d;
}
const dp = document.getElementById('bookingDate');
dp.value = getNextSat().toISOString().split('T')[0];
dp.min   = new Date().toISOString().split('T')[0];
updateHint();
dp.addEventListener('change', updateHint);

function updateHint() {
  if (!dp.value) return;
  const d    = new Date(dp.value + 'T00:00:00');
  const days = Math.round((d - new Date().setHours(0,0,0,0)) / 86400000);
  const nice = d.toLocaleDateString('en-AU', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('dateHint').innerHTML = '<span>' + nice + '</span> ‚Äî ' + days + ' day' + (days!==1?'s':'') + ' from today';
}

function generate() {
  const earliest  = document.getElementById('earliest').value;
  const latest    = document.getElementById('latest').value;
  const booktype  = document.querySelector('input[name="booktype"]:checked').value;
  const tee       = document.querySelector('input[name="tee"]:checked').value;
  const dateVal   = document.getElementById('bookingDate').value;

  if (!dateVal)  { alert('Please select a booking date.'); return; }

  const d        = new Date(dateVal + 'T00:00:00');
  const dayName  = d.toLocaleDateString('en-AU', {weekday:'long'});
  const dateNice = d.toLocaleDateString('en-AU', {day:'numeric',month:'long',year:'numeric'});

  const isGroup = booktype === 'group';

  const bookBtnSelector = isGroup
    ? '"BOOK GROUP"'
    : '"BOOK ME"';
  const bookBtnComment = booktype === 'group'
    ? '# Clicks "BOOK GROUP" ‚Äî books the whole tee time'
    : booktype === 'join'
    ? '# Clicks "BOOK ME" on a row where others are already booked'
    : '# Clicks "BOOK ME" on a fully empty row (no one else booked yet)';

  const script =
'"""\n' +
'The Lakes Golf Club - Automated Tee Time Booker\n' +
'Generated: ' + new Date().toLocaleDateString('en-AU') + ' | Mode: ' + (isGroup?'Book Group':'Book Me') + '\n' +
'================================================\n' +
'Runs via GitHub Actions automatically\n' +
'"""\n\n' +
'import os, sys, re, logging\n' +
'from datetime import datetime\n' +
'from dotenv import load_dotenv\n' +
'from playwright.sync_api import sync_playwright\n\n' +
'load_dotenv()\n\n' +
'CONFIG = {\n' +
'    "username":      os.getenv("GOLF_USERNAME"),  # Set GOLF_USERNAME in GitHub Secrets\n' +
'    "password":      os.getenv("GOLF_PASSWORD"),  # Set GOLF_PASSWORD in GitHub Secrets\n' +
'    "booking_date":  "' + dateVal + '",   # ' + dayName + ' ' + dateNice + '\n' +
'    "book_mode":     "' + booktype + '",  ' + bookBtnComment + '\n' +
'    "tee":           "' + tee + '",       # Only book slots starting from this tee\n' +
'    "earliest_time": "' + earliest + '",\n' +
'    "latest_time":   "' + latest + '",\n' +
'    "headless":      True,               # Must be True on GitHub Actions (no display)\n' +
'    "login_url":     "https://www.thelakesgolfclub.com.au/security/login.msp",\n' +
'    "booking_url":   "https://www.thelakesgolfclub.com.au/members/bookings/index.xsp?booking_resource_id=3000000",\n' +
'}\n\n' +
'logging.basicConfig(level=logging.INFO, format="%(asctime)s  %(levelname)s  %(message)s")\n' +
'log = logging.getLogger("golf_booker")\n\n' +
'def time_in_window(t_str):\n' +
'    try:\n' +
'        t  = datetime.strptime(t_str.strip().zfill(5), "%H:%M").time()\n' +
'        lo = datetime.strptime(CONFIG["earliest_time"], "%H:%M").time()\n' +
'        hi = datetime.strptime(CONFIG["latest_time"],   "%H:%M").time()\n' +
'        return lo <= t <= hi\n' +
'    except ValueError:\n' +
'        return False\n\n' +
'def row_has_players(tee_row):\n' +
'    # Returns True if any cell has class cell-taken (player already booked)\n' +
'    return tee_row.locator(\"div.cell-taken\").count() > 0\n\n' +
'def run():\n' +
'    target_date = datetime.strptime(CONFIG[\"booking_date\"], \"%Y-%m-%d\")\n' +
'    book_mode   = CONFIG[\"book_mode\"]\n' +
'    tee_filter  = CONFIG[\"tee\"]\n' +
'    btn_label   = \"Book Group\" if book_mode == \"group\" else \"Book Me\"\n' +
'    # strftime "%-d" removes leading zero on Linux; "%#d" on Windows\n' +
'    import platform\n' +
'    fmt = \"%#d %b\" if platform.system() == \"Windows\" else \"%-d %b\"\n' +
'    date_label = target_date.strftime(fmt)\n' +
'    log.info(\"=\" * 50)\n' +
'    log.info(f\"Target:  {target_date.strftime(\'%A %d %B %Y\')}\")\n' +
'    log.info(f\"Mode:    {btn_label}  |  Tee: {tee_filter}\")\n' +
'    log.info(f\"Window:  {CONFIG[\'earliest_time\']}‚Äì{CONFIG[\'latest_time\']}\")\n' +
'    log.info(\"=\" * 50)\n' +
'\n' +
'    with sync_playwright() as p:\n' +
'        browser = p.chromium.launch(headless=CONFIG[\"headless\"])\n' +
'        page    = browser.new_context().new_page()\n' +
'\n' +
'        # ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
'        log.info(\"Logging in...\")\n' +
'        page.goto(CONFIG[\"login_url\"], wait_until=\"networkidle\")\n' +
'        for sel in [\'input[name=\"memberLogin\"]\', \'input[name=\"username\"]\', \'input[type=\"text\"]:visible\']:\n' +
'            if page.locator(sel).count() > 0:\n' +
'                page.fill(sel, CONFIG[\"username\"]); break\n' +
'        for sel in [\'input[name=\"memberPassword\"]\', \'input[name=\"password\"]\', \'input[type=\"password\"]\']:\n' +
'            if page.locator(sel).count() > 0:\n' +
'                page.fill(sel, CONFIG[\"password\"]); break\n' +
'        for sel in [\'input[type=\"submit\"]\', \'button[type=\"submit\"]\', \'button:has-text(\"Login\")\']:\n' +
'            if page.locator(sel).count() > 0:\n' +
'                page.click(sel); break\n' +
'        page.wait_for_load_state(\"networkidle\")\n' +
'        if any(x in page.inner_text(\"body\").lower() for x in [\"invalid password\", \"login failed\"]):\n' +
'            log.error(\"Login failed.\"); page.screenshot(path=\"login_failed.png\"); browser.close(); sys.exit(1)\n' +
'        log.info(\"Logged in successfully.\")\n' +
'\n' +
'        # ‚îÄ‚îÄ NAVIGATE TO BOOKING PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
'        page.goto(CONFIG[\"booking_url\"], wait_until=\"networkidle\")\n' +
'        page.wait_for_timeout(4000)\n' +
'\n' +
'        # ‚îÄ‚îÄ FIND TARGET DATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
'        log.info(f\"Looking for date: {date_label}\")\n' +
'        booked = False\n' +
'        try:\n' +
'            page.wait_for_selector(\".full\", timeout=10000)\n' +
'            event_blocks = page.locator(\".full\").all()\n' +
'            log.info(f\"Found {len(event_blocks)} event blocks on page\")\n' +
'            found = False\n' +
'            for block in event_blocks:\n' +
'                try:\n' +
'                    block_text = block.inner_text(timeout=500)\n' +
'                    if date_label not in block_text:\n' +
'                        continue\n' +
'                    log.info(f\"Found block containing {date_label}\")\n' +
'                    open_link = block.locator(\"a.eventStatusOpen\").first\n' +
'                    if open_link.count() == 0:\n' +
'                        log.warning(\"Date found but not OPEN (may be LOCKED or VIEW ONLY)\")\n' +
'                        page.screenshot(path=\"not_open.png\")\n' +
'                        browser.close(); sys.exit(1)\n' +
'                    href = open_link.get_attribute(\"href\")\n' +
'                    log.info(f\"Navigating to: {href}\")\n' +
'                    page.goto(f\"https://www.thelakesgolfclub.com.au{href}\", wait_until=\"networkidle\")\n' +
'                    page.wait_for_timeout(3000)\n' +
'                    found = True\n' +
'                    break\n' +
'                except Exception as e:\n' +
'                    log.debug(f\"Block error: {e}\")\n' +
'                    continue\n' +
'            if not found:\n' +
'                log.warning(f\"Date {date_label} not found on page\")\n' +
'                page.screenshot(path=\"date_not_found.png\")\n' +
'                browser.close(); sys.exit(1)\n' +
'\n' +
'            # ‚îÄ‚îÄ SCAN TEE SHEET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n' +
'            page.wait_for_selector(\"div.row-time\", timeout=10000)\n' +
'            page.wait_for_timeout(2000)\n' +
'            tee_rows = page.locator(\"div.row-time\").all()\n' +
'            log.info(f\"Found {len(tee_rows)} tee time rows\")\n' +
'\n' +
'            for tee_row in tee_rows:\n' +
'                try:\n' +
'                    row_text = tee_row.inner_text(timeout=500)\n' +
'\n' +
'                    if tee_filter == \"1ST TEE\" and \"1st Tee\" not in row_text:\n' +
'                        continue\n' +
'                    if tee_filter == \"10TH TEE\" and \"10th Tee\" not in row_text:\n' +
'                        continue\n' +
'\n' +
'                    times = re.findall(r\'\\b(\\d{1,2}:\\d{2})\\s*(am|pm)\\b\', row_text, re.IGNORECASE)\n' +
'                    if not times:\n' +
'                        continue\n' +
'                    raw_time = times[0][0] + \" \" + times[0][1].upper()\n' +
'                    try:\n' +
'                        t24 = datetime.strptime(raw_time, \"%I:%M %p\").strftime(\"%H:%M\")\n' +
'                    except Exception:\n' +
'                        t24 = times[0][0].zfill(5)\n' +
'\n' +
'                    if not time_in_window(t24):\n' +
'                        continue\n' +
'\n' +
'                    cells = tee_row.locator(\"[data-rowid]\").all()\n' +
'                    if not cells:\n' +
'                        continue\n' +
'\n' +
'                    has_players  = row_has_players(tee_row)\n' +
'                    free_spots   = tee_row.locator(\"span.btn-label\").count()\n' +
'                    log.info(f\"  {raw_time} ({tee_filter}): has_players={has_players}, free_spots={free_spots}\")\n' +
'\n' +
'                    if book_mode == \"new\" and has_players:\n' +
'                        log.info(f\"  Skipping {raw_time} ‚Äî row has existing players (mode=new)\")\n' +
'                        continue\n' +
'                    if book_mode == \"join\" and not has_players:\n' +
'                        log.info(f\"  Skipping {raw_time} ‚Äî no existing players (mode=join)\")\n' +
'                        continue\n' +
'\n' +
'                    if book_mode == \"group\":\n' +
'                        btn = tee_row.locator(\"button.btn-book-group:not(.hide)\").first\n' +
'                    else:\n' +
'                        btn = tee_row.locator(\"button.btn-book-me:not(.hide)\").first\n' +
'\n' +
'                    if btn.count() == 0:\n' +
'                        log.debug(\"  Button not available, skipping\")\n' +
'                        continue\n' +
'\n' +
'                    log.info(f\"  Clicking \'{btn_label}\' at {raw_time}...\")\n' +
'                    btn.click()\n' +
'                    page.wait_for_load_state(\"networkidle\")\n' +
'                    page.wait_for_timeout(2000)\n' +
'\n' +
'                    for cs in [\'button:has-text(\"Confirm\")\', \'button:has-text(\"OK\")\', \'button:has-text(\"Yes\")\', \'button:has-text(\"Submit\")\']:\n' +
'                        try:\n' +
'                            cb = page.locator(cs).first\n' +
'                            if cb.is_visible(timeout=2000):\n' +
'                                cb.click(); page.wait_for_load_state(\"networkidle\")\n' +
'                                log.info(\"  Confirmation clicked\"); break\n' +
'                        except Exception: continue\n' +
'\n' +
'                    booked = True\n' +
'                    log.info(f\"  ‚úÖ Booked \'{btn_label}\' at {raw_time}!\")\n' +
'                    break\n' +
'\n' +
'                except Exception as e:\n' +
'                    log.debug(f\"  Row error: {e}\")\n' +
'                    continue\n' +
'\n' +
'        except Exception as e:\n' +
'            log.warning(f\"Booking error: {e}\")\n' +
'\n' +
'        ts = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n' +
'        fn = f\"booking_{\'success\' if booked else \'failed\'}_{ts}.png\"\n' +
'        page.screenshot(path=fn, full_page=True)\n' +
'        log.info(f\"Screenshot saved: {fn}\")\n' +
'        browser.close()\n' +
'\n' +
'    if booked:\n' +
'        log.info(\"‚úÖ Tee time booked successfully!\")\n' +
'    else:\n' +
'        log.warning(\"‚ùå No booking made ‚Äî check screenshot for details.\")\n' +
'\n' +
'if __name__ == \"__main__\":\n' +
'    run()\n';

  document.getElementById('scriptOutput').textContent = script;
  window._script = script;

  const modeDesc = booktype === 'group' ? 'BOOK GROUP (whole tee time)' : booktype === 'join' ? 'BOOK ME on a slot with existing players' : 'BOOK ME on a fresh empty slot';
  document.getElementById('instructions').innerHTML =
    '<p>1. Click <strong>‚Üì Download .py</strong> to save the script</p>' +
    '<p>2. The script runs automatically via GitHub Actions on the scheduled date</p>' +
    '<p>4. It will find the first <strong>' + modeDesc + '</strong> from the <strong>' + tee + '</strong> between <strong>' + earliest + ' ‚Äì ' + latest + '</strong> on <strong>' + dayName + ' ' + dateNice + '</strong></p>';

  const out = document.getElementById('outputSection');
  out.classList.add('visible');
  out.scrollIntoView({behavior:'smooth', block:'start'});
}

function downloadScript() {
  if (!window._script) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([window._script], {type:'text/plain'}));
  a.download = 'lakes_golf_booker.py';
  a.click();
}


// ‚îÄ‚îÄ PIN-BASED TOKEN DECRYPTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Token is AES-256-CBC encrypted. Only your PIN can decrypt it.
// Even if someone reads the source, they cannot use the token without the PIN.
const ENCRYPTED_TOKEN = '4aa70d8d1781248d0beb67b22efb957d:4d39403a104b1c427ff5b1930be6505f174a734b7a2e4a0d4add601467554a2be8cfaca7cd50c80e853478e54b6131a8';
const SALT = 'lakes-golf-booker';

async function deriveKey(pin) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pin), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: enc.encode(SALT), iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-CBC', length: 256 },
    false,
    ['decrypt']
  );
}

function hexToBytes(hex) {
  const arr = new Uint8Array(hex.length / 2);
  for (let i = 0; i < arr.length; i++) arr[i] = parseInt(hex.substr(i*2, 2), 16);
  return arr;
}

async function decryptToken(pin) {
  try {
    const [ivHex, dataHex] = ENCRYPTED_TOKEN.split(':');
    const iv   = hexToBytes(ivHex);
    const data = hexToBytes(dataHex);
    const key  = await deriveKey(pin);
    const dec  = await crypto.subtle.decrypt({ name: 'AES-CBC', iv }, key, data);
    return new TextDecoder().decode(dec);
  } catch(e) {
    return null;
  }
}

async function getToken() {
  const pin = document.getElementById('ghPin').value.trim();
  if (!pin) return null;
  const token = await decryptToken(pin);
  if (!token) {
    document.getElementById('pinHint').innerHTML = '<span style="color:#c0392b">‚ùå Wrong PIN ‚Äî token could not be decrypted</span>';
    return null;
  }
  document.getElementById('pinHint').innerHTML = '<span style="color:var(--green-light)">‚úÖ PIN accepted</span>';
  return token;
}

// Update schedule hint when date or days-advance changes
function updateScheduleHint() {
  const dateVal  = document.getElementById('bookingDate').value;
  const days     = parseInt(document.getElementById('daysAdvance').value);
  const openTime = document.getElementById('openTime').value || '07:00';
  if (!dateVal) return;

  if (days === 0) {
    document.getElementById('scheduleHint').innerHTML =
      '<span style="color:#c9a84c">‚ö° Test run ‚Äî script will fire <strong>immediately</strong> when you push</span>';
    return;
  }

  const play   = new Date(dateVal + 'T00:00:00');
  const runDay = new Date(play);
  runDay.setDate(play.getDate() - days);

  // Calculate run time = openTime minus 1 minute
  const [openH, openM] = openTime.split(':').map(Number);
  let runM = openM - 1, runH = openH;
  if (runM < 0) { runM = 59; runH -= 1; }
  if (runH < 0)   runH = 23;
  const runTimeFmt = String(runH).padStart(2,'0') + ':' + String(runM).padStart(2,'0');

  const niceRun  = runDay.toLocaleDateString('en-AU', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  const nicePlay = play.toLocaleDateString('en-AU', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
  document.getElementById('scheduleHint').innerHTML =
    'Script runs at <span style="color:var(--green-light)">' + runTimeFmt + '</span> on <span style="color:var(--green-light)">' + niceRun + '</span> ‚Äî 1 min before bookings open at ' + openTime + ', ' + days + ' days before your round on <span style="color:var(--green-light)">' + nicePlay + '</span>';
}
function syncOpenTime() {
  const h = document.getElementById('openHour').value;
  const m = document.getElementById('openMinute').value;
  document.getElementById('openTime').value = h + ':' + m;
  updateScheduleHint();
}
document.getElementById('openHour').addEventListener('change', syncOpenTime);
document.getElementById('openMinute').addEventListener('change', syncOpenTime);
document.getElementById('daysAdvance').addEventListener('change', updateScheduleHint);
dp.addEventListener('change', updateScheduleHint);
updateScheduleHint();

// ‚îÄ‚îÄ STEP RENDERER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStep(id, icon, label, detail, state) {
  const el = document.getElementById('step-' + id) || document.createElement('div');
  el.id = 'step-' + id;
  el.className = 'step ' + state;
  el.innerHTML = state === 'running'
    ? '<div class="spinner"></div><div class="step-text"><div>' + label + '</div><div class="step-detail">' + detail + '</div></div>'
    : '<div class="step-icon">' + icon + '</div><div class="step-text"><div>' + label + '</div><div class="step-detail">' + detail + '</div></div>';
  if (!document.getElementById('step-' + id)) {
    document.getElementById('statusSteps').appendChild(el);
  }
}

// ‚îÄ‚îÄ GITHUB API HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function ghAPI(token, method, path, body) {
  const r = await fetch('https://api.github.com' + path, {
    method,
    headers: { Authorization: 'token ' + token, 'Content-Type': 'application/json', 'Accept': 'application/vnd.github.v3+json' },
    body: body ? JSON.stringify(body) : undefined
  });
  // 204 No Content (e.g. workflow_dispatch) returns empty body ‚Äî don't parse as JSON
  if (r.status === 204) return {};
  const data = await r.json();
  if (!r.ok) throw new Error(data.message || r.statusText);
  return data;
}

async function upsertFile(token, repo, filePath, content, message) {
  // Get current SHA if file exists
  let sha;
  try {
    const existing = await ghAPI(token, 'GET', '/repos/' + repo + '/contents/' + filePath);
    sha = existing.sha;
  } catch(e) { sha = null; }
  const body = { message, content: btoa(unescape(encodeURIComponent(content))) };
  if (sha) body.sha = sha;
  return ghAPI(token, 'PUT', '/repos/' + repo + '/contents/' + filePath, body);
}

function copyScript() {
  if (!window._script) return;
  navigator.clipboard.writeText(window._script).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = '‚úì Copied'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = '‚éò Copy'; btn.classList.remove('copied'); }, 2000);
  });
}

// ‚îÄ‚îÄ BOOKING SCHEDULE (GitHub-backed schedule.json) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// schedule.json lives in the repo root ‚Äî reads are public, writes use token.
const REPO          = 'kienzo/booking-agent';
const SCHEDULE_FILE = 'schedule.json';
let   _scheduleCache = null;

async function fetchScheduleFromGitHub(token) {
  try {
    // Use GitHub API (not raw CDN) so we always get the live version, never a cached copy
    const headers = { 'Accept': 'application/vnd.github.v3+json' };
    if (token) headers['Authorization'] = 'token ' + token;
    const r = await fetch('https://api.github.com/repos/' + REPO + '/contents/' + SCHEDULE_FILE, { headers });
    if (!r.ok) return [];
    const data = await r.json();
    // Content is base64-encoded
    const decoded = decodeURIComponent(escape(atob(data.content)));
    return JSON.parse(decoded);
  } catch(e) { return []; }
}

async function pushScheduleToGitHub(entries) {
  const token = await getToken();
  if (!token) throw new Error('Wrong PIN or no PIN entered ‚Äî cannot save to cloud');
  await upsertFile(token, REPO, SCHEDULE_FILE, JSON.stringify(entries, null, 2), 'update booking schedule');
}

async function addScheduleEntry(entry) {
  const token = await getToken();
  if (!token) throw new Error('Wrong PIN ‚Äî cannot save to cloud');
  // Use token so GitHub API returns live data, never cached
  const entries = await fetchScheduleFromGitHub(token);
  const idx = entries.findIndex(e => e.playDate === entry.playDate);
  if (idx >= 0) entries[idx] = entry; else entries.unshift(entry);
  entries.sort((a,b) => a.playDate < b.playDate ? 1 : -1);
  entries.splice(20);
  await upsertFile(token, REPO, SCHEDULE_FILE, JSON.stringify(entries, null, 2), 'update booking schedule');
  _scheduleCache = entries;
  renderSchedule(entries);
}

async function deleteScheduleEntry(playDate) {
  const pin = document.getElementById('ghPin').value.trim();
  if (!pin) {
    alert('Enter your PIN in Section 05 first, then try deleting again.');
    document.getElementById('ghPin').focus();
    document.getElementById('ghPin').scrollIntoView({behavior:'smooth', block:'center'});
    return;
  }
  const token = await getToken();
  if (!token) { alert('Wrong PIN ‚Äî token could not be decrypted.'); return; }

  // Show deleting state on the row
  const rows = document.querySelectorAll('.sched-delete');
  rows.forEach(b => b.disabled = true);

  try {
    const tok     = await getToken();
    const fresh   = await fetchScheduleFromGitHub(tok);
    const entries = fresh.filter(e => e.playDate !== playDate);
    await upsertFile(tok, REPO, SCHEDULE_FILE, JSON.stringify(entries, null, 2), 'update booking schedule');
    _scheduleCache = entries;
    renderSchedule(entries);
  } catch(err) {
    alert('Delete failed: ' + err.message);
    rows.forEach(b => b.disabled = false);
  }
}

async function initSchedule() {
  renderSchedule(null);
  // No token needed for initial load ‚Äî uses public API rate limit
  const entries = await fetchScheduleFromGitHub();
  _scheduleCache = entries;
  renderSchedule(entries);
}

function renderSchedule(entries) {
  const container = document.getElementById('scheduleList');
  if (entries === null) {
    container.innerHTML = '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:28px 0;letter-spacing:1px;">Loading schedule from GitHub...</p>';
    return;
  }
  const now = new Date();
  now.setHours(0,0,0,0);

  if (!entries.length) {
    container.innerHTML = '<p style="font-size:12px;color:var(--text-muted);text-align:center;padding:28px 0;letter-spacing:1px;">No bookings scheduled yet ‚Äî push your first one above ‚Üë</p>';
    return;
  }

  container.innerHTML = entries.map(e => {
    const playD  = new Date(e.playDate + 'T00:00:00');
    const runD   = new Date(e.runDate  + 'T00:00:00');
    const isPast = runD < now;
    const isToday = runD.toDateString() === now.toDateString();
    const isFuture = runD > now;
    const playDays = Math.round((playD - now) / 86400000);

    let badge, badgeClass;
    if (isPast)    { badge = 'Script Ran'; badgeClass = 'badge-past'; }
    else if (isToday) { badge = 'Running Today'; badgeClass = 'badge-today'; }
    else           { badge = 'Scheduled'; badgeClass = 'badge-future'; }

    const playNice = playD.toLocaleDateString('en-AU', {weekday:'short', day:'numeric', month:'short', year:'numeric'});
    const runNice  = runD.toLocaleDateString('en-AU',  {weekday:'short', day:'numeric', month:'short', year:'numeric'});
    const daysLabel = isPast ? 'played' : playDays === 0 ? 'today!' : playDays + ' days away';

    // Countdown to script run time
    const now2 = new Date();
    let scriptRunsIn = '';
    if (!isPast && !isToday && e.runTime) {
      const [rh, rm] = e.runTime.split(':').map(Number);
      const runDateTime = new Date(e.runDate + 'T' + e.runTime + ':00');
      const diffMs = runDateTime - now2;
      if (diffMs > 0) {
        const diffDays = Math.floor(diffMs / 86400000);
        const diffHrs  = Math.floor((diffMs % 86400000) / 3600000);
        if (diffDays > 0) scriptRunsIn = diffDays + 'd ' + diffHrs + 'h away';
        else scriptRunsIn = diffHrs + 'h away';
      }
    }

    return `<div class="sched-row">
      <div class="sched-left">
        <div class="sched-play-date">${playNice}</div>
        <div class="sched-meta">
          <span class="${badgeClass} badge">${badge}</span>
          <span class="sched-detail">‚õ≥ ${e.tee}</span>
          <span class="sched-detail">üïê ${e.earliest}‚Äì${e.latest}</span>
          <span class="sched-detail">${e.mode === 'group' ? 'üë• Group' : e.mode === 'join' ? 'ü§ù Join' : 'üèåÔ∏è New Slot'}</span>
        </div>
        <div class="sched-run-info ${isPast ? 'past' : isToday ? 'today' : ''}">
          <span class="sched-run-label">${isPast ? 'üèÅ Script ran' : isToday ? '‚ö° Running today' : '‚è∞ Script fires'}</span>
          <span class="sched-run-datetime">${runNice} at ${e.runTime || '‚Äî'}</span>
          ${scriptRunsIn ? `<span class="sched-run-countdown">${scriptRunsIn}</span>` : ''}
          <a href="https://github.com/kienzo/booking-agent/actions" target="_blank" class="sched-actions-link">View on GitHub ‚Üó</a>
        </div>
      </div>
      <div class="sched-right">
        <span class="sched-countdown ${isPast ? 'past' : ''}">${daysLabel}</span>
        <button class="sched-delete" onclick="deleteScheduleEntry('${e.playDate}')" title="Remove">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ MAIN PUSH FUNCTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateAndPush() {
  const token = await getToken();
  if (!token) { alert('Enter your PIN in Section 05 to unlock GitHub access.'); return; }

  const dateVal   = document.getElementById('bookingDate').value;
  if (!dateVal)  { alert('Please select a booking date.'); return; }

  // Generate the script first
  generate();

  const script    = window._script;
  const days      = parseInt(document.getElementById('daysAdvance').value);
  const openTime  = document.getElementById('openTime').value || '07:00';
  const isNowRun  = days === 0;
  const play      = new Date(dateVal + 'T00:00:00');
  const runDay    = new Date(play);
  runDay.setDate(play.getDate() - days);

  // Calculate local run time = bookings open time minus 1 minute
  const [openH, openM] = openTime.split(':').map(Number);
  let localRunM = openM - 1, localRunH = openH;
  if (localRunM < 0) { localRunM = 59; localRunH -= 1; }
  if (localRunH < 0)   localRunH = 23;

  // Convert local Sydney time to UTC for cron (AEST=UTC+10, AEDT=UTC+11)
  const runMonth = runDay.getMonth() + 1;
  const isDST    = runMonth >= 10 || runMonth <= 4;
  const offset   = isDST ? 11 : 10;
  let cronH = localRunH - offset;
  let cronDayOffset = 0;
  if (cronH < 0) { cronH += 24; cronDayOffset = -1; }
  const cronRunDay = new Date(runDay);
  cronRunDay.setDate(runDay.getDate() + cronDayOffset);
  const cronMin  = localRunM;
  const cronHour = cronH;
  const cronDay  = cronRunDay.getDate();
  const cronMon  = cronRunDay.getMonth() + 1;
  const cronExpr = cronMin + ' ' + cronHour + ' ' + cronDay + ' ' + cronMon + ' *';

  const localRunTimeFmt = String(localRunH).padStart(2,'0') + ':' + String(localRunM).padStart(2,'0');
  const utcTimeFmt      = String(cronHour).padStart(2,'0') + ':' + String(cronMin).padStart(2,'0');

  const nicePlay = play.toLocaleDateString('en-AU', {weekday:'long',day:'numeric',month:'long',year:'numeric'});
  const niceRun  = runDay.toLocaleDateString('en-AU', {weekday:'long',day:'numeric',month:'long',year:'numeric'});

  // For "Now" runs: workflow_dispatch only (no cron). For scheduled: include cron.
  const workflow = isNowRun ?
`# TEST RUN ‚Äî triggered manually via workflow_dispatch
# Play date: ${nicePlay}
name: Golf Booker

on:
  workflow_dispatch:

jobs:
  book:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install playwright python-dotenv requests && playwright install chromium

      - name: Run booking agent
        env:
          GOLF_USERNAME: \${{ secrets.GOLF_USERNAME }}
          GOLF_PASSWORD: \${{ secrets.GOLF_PASSWORD }}
        run: python lakes_golf_booker.py
` :
`# Auto-generated by The Lakes Golf Booker UI
# Play date: ${nicePlay}
# Script runs: ${niceRun} at ${localRunTimeFmt} local / ${utcTimeFmt} UTC (1 min before bookings open at ${openTime})
name: Golf Booker

on:
  schedule:
    - cron: '${cronExpr}'
  workflow_dispatch:

jobs:
  book:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install playwright python-dotenv requests && playwright install chromium

      - name: Run booking agent
        env:
          GOLF_USERNAME: \${{ secrets.GOLF_USERNAME }}
          GOLF_PASSWORD: \${{ secrets.GOLF_PASSWORD }}
        run: python lakes_golf_booker.py
`;

  // Show status panel
  const statusSection = document.getElementById('statusSection');
  statusSection.classList.add('visible');
  document.getElementById('statusSteps').innerHTML = '';
  statusSection.scrollIntoView({behavior:'smooth', block:'start'});

  try {
    // Step 1: Verify token
    renderStep('auth', 'üîë', 'Authenticating with GitHub', 'Checking token permissions...', 'running');
    await ghAPI(token, 'GET', '/repos/' + REPO);
    renderStep('auth', '‚úÖ', 'Authenticated', 'Token accepted ‚Äî repo access confirmed', 'success');

    // Step 2: Push Python script
    renderStep('script', 'üêç', 'Uploading lakes_golf_booker.py', 'Writing booking script to repository...', 'running');
    await upsertFile(token, REPO, 'lakes_golf_booker.py', script, 'ü§ñ Update booking script ‚Äî target: ' + dateVal);
    renderStep('script', '‚úÖ', 'lakes_golf_booker.py updated', 'Booking date set to ' + nicePlay, 'success');

    // Step 3: Push workflow
    const workflowLabel = isNowRun ? 'Pushing workflow for test run...' : 'Setting cron to run on ' + niceRun + '...';
    renderStep('workflow', '‚öôÔ∏è', isNowRun ? 'Preparing test run' : 'Scheduling GitHub Actions workflow', workflowLabel, 'running');
    await upsertFile(token, REPO, '.github/workflows/golf-booker.yml', workflow, isNowRun ? '‚ö° Test run' : 'üïê Schedule run for ' + niceRun + ' (plays ' + dateVal + ')');
    renderStep('workflow', '‚úÖ', isNowRun ? 'Workflow pushed' : 'Workflow scheduled', isNowRun ? 'Ready to trigger' : 'Runs ' + niceRun + ' at ' + localRunTimeFmt + ' local (' + utcTimeFmt + ' UTC)', 'success');

    // Step 4: For Now runs ‚Äî trigger immediately via API
    if (isNowRun) {
      renderStep('trigger', '‚ö°', 'Triggering run now', 'Dispatching workflow on GitHub...', 'running');
      await ghAPI(token, 'POST', '/repos/' + REPO + '/actions/workflows/golf-booker.yml/dispatches', { ref: 'main' });
      renderStep('trigger', '‚úÖ', 'Workflow triggered!', 'Script is running now ‚Äî check Actions tab for live logs', 'success');
    }

    // Step 5: Save booking to schedule.json in repo
    renderStep('sched', 'üìÖ', 'Saving to booking schedule', 'Writing schedule.json to repository...', 'running');
    await addScheduleEntry({
      playDate: dateVal,
      runDate:  runDay.toISOString().split('T')[0],
      tee:      document.querySelector('input[name="tee"]:checked').value,
      earliest: document.getElementById('earliest').value,
      latest:   document.getElementById('latest').value,
      mode:     document.querySelector('input[name="booktype"]:checked').value,
      openTime: openTime,
      runTime:  isNowRun ? 'now' : localRunTimeFmt,
      pushedAt: new Date().toISOString()
    });
    renderStep('sched', '‚úÖ', 'Schedule saved to GitHub', 'schedule.json updated ‚Äî visible from any device', 'success');

    const bannerMsg = isNowRun
      ? `<h3>‚ö° Test run triggered!</h3>
         <p>The script is running right now on GitHub's servers. Watch the live logs to see if it books successfully.</p>`
      : `<h3>‚úÖ All done ‚Äî you're scheduled!</h3>
         <p>Your script will run automatically on <strong>${niceRun}</strong> at <strong>${localRunTimeFmt}</strong> ‚Äî 1 min before bookings open for your round on <strong>${nicePlay}</strong>.</p>`;

    document.getElementById('statusSteps').insertAdjacentHTML('afterend', `
      <div class="gh-success-banner">
        ${bannerMsg}
        <p style="margin-top:12px;">
          <a href="https://github.com/${REPO}/actions" target="_blank" class="gh-link">‚Üí View live logs on GitHub Actions ‚Üó</a>
        </p>
      </div>`);

  } catch(err) {
    const lastRunning = document.querySelector('.step.running');
    if (lastRunning) {
      lastRunning.className = 'step error';
      lastRunning.querySelector('.step-text').innerHTML += '<div class="step-detail" style="color:#c0392b">Error: ' + err.message + '</div>';
      lastRunning.innerHTML = lastRunning.innerHTML.replace('<div class="spinner"></div>', '<div class="step-icon">‚ùå</div>');
    }
    console.error(err);
  }
}

// Init schedule on page load
initSchedule();
</script>
</body>
</html>
